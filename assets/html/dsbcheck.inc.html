<div class="tab-content" style="padding-top: 0px !important;">
  <div class="row">
    <div class="col-sm-12">
      <h4 class="info-text">
        <i class="fa fa-check-circle-o"></i> Grundschutz-Check
      </h4>
    </div>
  </div>
  <div class="row">
    <div class="col-sm-12">
      <h5 class="info-text" id="mainTitle">
      </h5>
    </div>
    <div class="col-sm-offset-1 col-sm-10 table-responsive">
      <table class="table table-striped table-hover btn-table" id="overalltoms">
        <thead>
          <tr>
            <th>Kategorie</th>
            <th>Maßnahme</th>
            <th>Umsetzung</th>
            <th>Umgesetzt in</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  /**
   * Liste aller TOMs
   * @global
   * @type {Array}
   */
  let tomsMapping = [];

  /**
   * Bildet den Umsetzungsstand auf HTML ab
   * @global
   * @type {Object}
   */
  let implementationMapping = {
    '-1': '<span class="text-info">Unbearbeitet <i class="fa fa-question"></i></span>',
     '0': '<span class="text-danger">Nein <i class="fa fa-minus"></i></span>',
     '1': '<span class="text-success">Ja <i class="fa fa-plus"></i></span>',
     '2': '<span class="text-warning">Teilweise <i class="fa fa-plus"></i>/<i class="fa fa-minus"></i></span>',
     '4': '<span class="text-info">Entbehrlich <i class="fa fa-times"></i></span>'
  };

  /**
   * Punkte für verschiedene Umsetzungsstände
   * @global
   * @type {Object}
   */
  let implementationPoints = {
    '-1': 0,
     '0': 0,
     '1': 1,
     '2': 0.5,
     '4': 1
  };

  /**
   * Fragt die TOMs einer Dokumentation und ihrer Abhängigkeiten ab
   * @param  {Number} docId ID der Dokumentation, die überprüft werden soll
   * @return {undefined}
   */
  function getCombinedTOMs(docId) {
   setOverlay();

   $.post(backendPath, JSON.stringify({'action':'tomcheck', 'id': docId, 'debug': debug})).done((data) => {
     if(!data['success']) {
       showError('Einsammeln der TOMs', data['error']);
       return;
     }

     // Seitentitel setzen
     $('#mainTitle').text(`${data.data.docs[docId].allgemein_bezeichnung} (#${docId})`);
     window.document.title += ` - Grundschutz-Check für ${data.data.docs[docId].allgemein_bezeichnung} (#${docId})`;

     // Verwendungen der einzelnen Maßnahmen und Umsetzungspunkte zählen
     for(let tomKey in tomsMapping) {
       tomsMapping[tomKey].docCount  = 0;
       tomsMapping[tomKey].docPoints = 0;
       if(('massnahmen_' + tomsMapping[tomKey].Identifier) in data['data']['toms']) {
         tomsMapping[tomKey].docCount = data.data.toms['massnahmen_' + tomsMapping[tomKey].Identifier].length;

         if(tomsMapping[tomKey].docCount > 0) {
           for(let tomDoc of data.data.toms['massnahmen_' + tomsMapping[tomKey].Identifier]) {
             tomsMapping[tomKey].docPoints += implementationPoints[tomDoc.data];
           }
         }
       }
     }

     // Alle TOMs durchgehen und verwendete in Tabelle eintragen
     let lastCat = '';
     for(let tom of tomsMapping) {
       if(tom.docCount === 0) continue;

       // Einträge pro Kategorie und Punkte zählen
       let docCountCat = 0;
       let catPoints   = 0;
       let tomCount    = 0;
       for(let tomTemp of tomsMapping) {
         if(tomTemp.Category === tom.Category && tomTemp.Subcategory === tom.Subcategory) {
           docCountCat += tomTemp.docCount;
           catPoints   += (tomTemp.docCount !== 0 ? tomTemp.docPoints / tomTemp.docCount : 0);
           tomCount++;
         }
       }

       if(docCountCat === 0) continue;

       // Eintrag für jede Verwendung einr Maßnahme
       let firstDoc = true;
       for(let tomDoc of data.data.toms['massnahmen_' + tom.Identifier]) {
         // Kategorie nur einmal anzeigen und rowspan nutzen
         let tableCatHTML = '';
         if(lastCat.trim() === '' || lastCat.trim() !== tom.Subcategory.trim()) {
           tableCatHTML = `
            <td rowspan="${docCountCat}">
              ${htmlEncode(tom.Subcategory)}
              <div class="progress pull-right" style="width: 30%;">
                <div class="progress-bar" role="progressbar" aria-valuenow="${Math.round((catPoints / tomCount) * 100)}" aria-valuemin="0" aria-valuemax="100" style="width: ${Math.round((catPoints / tomCount) * 100)}%;">
                  <span class="sr-only">${Math.round((catPoints / tomCount) * 100)}% Complete</span>
                </div>
              </div>
            </td>`;
         }

         // Maßnahme nur einmal anzeigen und rowspan nutzen
         let tomMeasureHTML = '';
         if(firstDoc) {
           tomMeasureHTML = `
            <td rowspan="${tom.docCount}">
              ${htmlEncode(tom.Identifier)}
              <div class="progress pull-right" style="width: 30%;">
                <div class="progress-bar" role="progressbar" aria-valuenow="${Math.round((tom.docPoints / tom.docCount) * 100)}" aria-valuemin="0" aria-valuemax="100" style="width: ${Math.round((tom.docPoints / tom.docCount) * 100)}%;">
                  <span class="sr-only">${Math.round((tom.docPoints / tom.docCount) * 100)}% Complete</span>
                </div>
              </div>
            </td>`;
         }

         // Umsetzungsstand und Kommentar vorbereiten
         let tomStatus    = implementationMapping[tomDoc.data];
         let tomIDComment = htmlEncode(tom.Identifier.replace(/\./g, '_') + tomDoc.id + '_kommentar');
         let tomComment   = '';

         if(Object.keys(data.data.toms).includes('massnahmen_' + tom.Identifier + '_kommentar')) {
           for(let tempComment of data.data.toms['massnahmen_' + tom.Identifier + '_kommentar']) {
             if(tempComment.id === tomDoc.id) {
               tomComment = tempComment.data.trim();
               break;
             }
           }
         }

         // Zeilen in Tabelle schreiben
         $('#overalltoms tbody').append(`
         <tr>
           ${tableCatHTML}
           ${tomMeasureHTML}
           <td>
             <div style="margin-bottom: 15px !important;">
               ${tomStatus}
               <button class="btn btn-sm pull-right ${tomComment === '' ? 'hidden' : ''}" type="button" data-toggle="collapse" data-target="#${tomIDComment}" aria-expanded="true" aria-controls="${tomIDComment}">Kommentar anzeigen</button>
             </div>
             <div class="collapse ${tomComment === '' ? 'hidden' : ''}" id="${tomIDComment}" aria-expanded="false">
               <div class="well" style="margin-bottom: 0px !important;padding: 10px !important;">${tomComment}</div>
             </div>
           </td>
           <td><a href="?id=${tomDoc.id}" target="_blank">${htmlEncode(data.data.docs[tomDoc.id]['allgemein_bezeichnung'])}</a></td>
         </tr>`);

         firstDoc = false;
         lastCat = tom.Subcategory;
       }

       lastCat = tom.Subcategory;
     }
   }).fail((jqXHR, error, errorThrown) => {
     showError('Einsammeln der TOMs', false, {'jqXHR': jqXHR, 'error': error, 'errorThrown': errorThrown});
   }).always(() => {
     setOverlay(false);
   });
  }

  /**
   * Fragt die aktuelle TOM-Liste ab und führt dann den Grundschutz-Check durch
   * @return {undefined}
   */
  function fetchTOMListAndCheckTOMs() {
    $.getJSON(backendPath + '?action=gettoms' + (debug ? '&debug=true' : '')).done((data) => {
      if(!data['success']) {
        showError('Holen der TOMs', data['error']);
        setOverlay(false);
        return;
      }

      if(data['data'].length === 0) {
        showError('Holen der TOMs', 'TOM Liste ist leer!');
        setOverlay(false);
        return;
      }

      tomsMapping = data['data'];
      // Nach Identifier sortieren
      tomsMapping = tomsMapping.sort((a,b) =>  a.Identifier.localeCompare(b.Identifier, 'en', { numeric: true }));

      getCombinedTOMs(loadIdMain);
    }).fail((jqXHR, error, errorThrown) => {
      showError('Holen der TOMs', false, {'jqXHR': jqXHR, 'error': error, 'errorThrown': errorThrown});
      setOverlay(false);
    });
  }

  setOverlay(true);
  fetchTOMListAndCheckTOMs();
</script>
