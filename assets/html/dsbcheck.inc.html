<div class="tab-content" style="padding-top: 0px !important;">
  <div class="row">
    <div class="col-sm-12">
      <h4 class="info-text">
        <i class="fa fa-check-circle-o"></i> Grundschutz-Check
      </h4>
    </div>
  </div>
  <div class="row">
    <div class="col-sm-12">
      <h5 class="info-text" id="mainTitle">
      </h5>
    </div>
    <div class="col-sm-offset-1 col-sm-10 table-responsive">
      <table class="table table-striped table-hover btn-table" id="overalltoms">
        <thead>
          <tr>
            <th>Baustein</th>
            <th>Maßnahme</th>
            <th>Umsetzung</th>
            <th>Kommentar</th>
            <th>Umgesetzt in</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
  </div>
</div>


<!-- DataTables -->
<script src="assets/js/datatables.min.js" type="text/javascript"></script>
<script src="assets/js/datatables_naturalsort.js" type="text/javascript"></script>

<script>
  /**
   * Liste aller TOMs
   * @global
   * @type {Array}
   */
  let tomsMapping = [];

  /**
   * Bildet den Umsetzungsstand auf HTML ab
   * @global
   * @type {Object}
   */
  let implementationMapping = {
    '-1': '<span class="text-info">Unbearbeitet</span>',
     '0': '<span class="text-danger">Nein</span>',
     '1': '<span class="text-success">Ja</span>',
     '2': '<span class="text-warning">Teilweise</span>',
     '4': '<span class="text-muted">Entbehrlich</span>'
  };

  /**
   * Punkte für verschiedene Umsetzungsstände
   * @global
   * @type {Object}
   */
  let implementationPoints = {
    '-1': 0,
     '0': 0,
     '1': 1,
     '2': 0.5,
     '4': 1
  };

  /**
   * Fragt die TOMs einer Dokumentation und ihrer Abhängigkeiten ab
   * @param  {Number} docId ID der Dokumentation, die überprüft werden soll
   * @return {undefined}
   */
  function getCombinedTOMs(docId) {
   setOverlay();

   $.post(backendPath, JSON.stringify({'action':'tomcheck', 'id': docId, 'debug': debug})).done((data) => {
     if(!data['success']) {
       showError('Einsammeln der TOMs', data['error']);
       return;
     }

     // Seitentitel setzen
     $('#mainTitle').text(`${data.data.docs[docId].allgemein_bezeichnung} (#${docId})`);
     window.document.title += ` - Grundschutz-Check für ${data.data.docs[docId].allgemein_bezeichnung} (#${docId})`;

     // Verwendungen der einzelnen Maßnahmen und Umsetzungspunkte zählen
     for(let tomKey in tomsMapping) {
       tomsMapping[tomKey].docCount  = 0;
       tomsMapping[tomKey].docPoints = 0;
       if(('massnahmen_' + tomsMapping[tomKey].Identifier) in data['data']['toms']) {
         tomsMapping[tomKey].docCount = data.data.toms['massnahmen_' + tomsMapping[tomKey].Identifier].length;

         if(tomsMapping[tomKey].docCount > 0) {
           for(let tomDoc of data.data.toms['massnahmen_' + tomsMapping[tomKey].Identifier]) {
             tomsMapping[tomKey].docPoints += implementationPoints[tomDoc.data];
           }
         }
       }
     }

     // Alle TOMs durchgehen und verwendete in Tabelle eintragen
     let lastCat = '';
     for(let tom of tomsMapping) {
       if(tom.docCount === 0) continue;

       // Einträge pro Kategorie und Punkte zählen
       let docCountCat = 0;
       let catPoints   = 0;
       let tomCount    = 0;
       for(let tomTemp of tomsMapping) {
         if(tomTemp.Category === tom.Category && tomTemp.Subcategory === tom.Subcategory) {
           docCountCat += tomTemp.docCount;
           catPoints   += (tomTemp.docCount !== 0 ? tomTemp.docPoints / tomTemp.docCount : 0);
           tomCount++;
         }
       }

       if(docCountCat === 0) continue;

       // Eintrag für jede Verwendung einr Maßnahme
       let firstDoc = true;
       for(let tomDoc of data.data.toms['massnahmen_' + tom.Identifier]) {
         let tableCatHTML = `
          <td data-percentage="${Math.round((catPoints / tomCount) * 100)}">
            ${htmlEncode(tom.Subcategory)}
          </td>`;

         let tomMeasureHTML = `
          <td>
            ${htmlEncode(tom.Identifier)}
          </td>`;

         // Umsetzungsstand und Kommentar vorbereiten
         let tomStatus    = implementationMapping[tomDoc.data];
         let tomIDComment = htmlEncode(tom.Identifier.replace(/\./g, '_') + tomDoc.id + '_kommentar');
         let tomComment   = '';

         if(Object.keys(data.data.toms).includes('massnahmen_' + tom.Identifier + '_kommentar')) {
           for(let tempComment of data.data.toms['massnahmen_' + tom.Identifier + '_kommentar']) {
             if(tempComment.id === tomDoc.id) {
               tomComment = htmlEncode(tempComment.data.trim());
               break;
             }
           }
         }

         // Zeilen in Tabelle schreiben
         $('#overalltoms tbody').append(`
         <tr>
           ${tableCatHTML}
           ${tomMeasureHTML}
           <td>
             ${tomStatus}
           </td>
           <td>
             <div class="well ${tomComment === '' ? 'hidden' : ''}" style="margin-bottom: 0px !important;padding: 10px !important;">${tomComment}</div>
           </td>
           <td><a href="?id=${tomDoc.id}" target="_blank">${htmlEncode(data.data.docs[tomDoc.id]['allgemein_bezeichnung'])}</a></td>
         </tr>`);

         firstDoc = false;
         lastCat = tom.Subcategory;
       }

       lastCat = tom.Subcategory;
     }

     $('#overalltoms').DataTable({
       'paging': false,
       'order': [1, 'asc'],
       'language': {
            'url': 'assets/js/datatables_german.json'
        },
        columnDefs: [
         { type: 'natural-nohtml', 'targets': '_all' }
       ],
       rowGroup: {
        dataSrc: 0,
        startRender: function(rows, group) {
          console.log(rows);
          console.log(group);
          let groupHeading = group +' ('+rows.count()+' Maßnahmen)';
          let groupPecentage = $(rows.nodes()[0]).children().first().data('percentage');
          let groupPercentageHTML = `
          <div class="progress pull-right" style="width: 30%; margin-bottom: 0px;">
            <div class="progress-bar" role="progressbar" aria-valuenow="${groupPecentage}" aria-valuemin="0" aria-valuemax="100" style="width: ${groupPecentage}%;">
              <span class="sr-only">${groupPecentage}% fertiggestellt</span>
            </div>
          </div>
          `;
          return $(`<tr><td colspan="5">${groupHeading} ${groupPercentageHTML}</td></tr>`);
        }
       }
     });
   }).fail((jqXHR, error, errorThrown) => {
     showError('Einsammeln der TOMs', false, {'jqXHR': jqXHR, 'error': error, 'errorThrown': errorThrown});
   }).always(() => {
     setOverlay(false);
   });
  }

  /**
   * Fragt die aktuelle TOM-Liste ab und führt dann den Grundschutz-Check durch
   * @return {undefined}
   */
  function fetchTOMListAndCheckTOMs() {
    $.getJSON(backendPath + '?action=gettoms' + (debug ? '&debug=true' : '')).done((data) => {
      if(!data['success']) {
        showError('Holen der TOMs', data['error']);
        setOverlay(false);
        return;
      }

      if(data['data'].length === 0) {
        showError('Holen der TOMs', 'TOM Liste ist leer!');
        setOverlay(false);
        return;
      }

      tomsMapping = data['data'];
      // Nach Identifier sortieren
      tomsMapping = tomsMapping.sort((a,b) =>  a.Identifier.localeCompare(b.Identifier, 'en', { numeric: true }));

      getCombinedTOMs(loadIdMain);
    }).fail((jqXHR, error, errorThrown) => {
      showError('Holen der TOMs', false, {'jqXHR': jqXHR, 'error': error, 'errorThrown': errorThrown});
      setOverlay(false);
    });
  }

  setOverlay(true);
  fetchTOMListAndCheckTOMs();
</script>
